name: Markdown to HTML and Update JSON
on:
  push:
    paths:
      - 'drafts/**'
  workflow_dispatch:

jobs:
  convert-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: sudo apt-get install -y pandoc

      - name: Convert Markdown to HTML
        run: |
          mkdir -p posts
          # Loop through every .md file in the drafts folder
          for file in drafts/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              echo "Processing $filename..."

              # Improved Metadata Extraction
              # This looks for 'title:' and grabs everything after it
              title=$(grep -i "^title:" "$file" | head -1 | sed 's/[Tt]itle:[[:space:]]*//' || echo "New Resource")
              date=$(grep -i "^date:" "$file" | head -1 | sed 's/[Dd]ate:[[:space:]]*//' || echo "Recently Added")
              excerpt=$(grep -i "^excerpt:" "$file" | head -1 | sed 's/[Ee]xcerpt:[[:space:]]*//' || echo "Click to read more.")

              # Remove any remaining dash characters from the start/end
              title=$(echo "$title" | sed 's/^---//; s/---$//')

              # Generate the Body (everything after the second ---)
              # If your file doesn't have a second ---, it just converts the whole file
              body=$(sed '1,/---/d;1,/---/d' "$file" | pandoc -f markdown -t html || pandoc -f markdown -t html "$file")

              # Write the HTML file
              cat <<EOF > posts/${filename}.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <title>${title} | Desmond Delgadillo</title>
              <link rel="stylesheet" href="../style.css">
          </head>
          <body>
              <nav><a href="../index.html" class="logo">DD</a><div><a href="../index.html">Home</a><a href="../blogs.html">Resources</a></div></nav>
              <main>
                  <article>
                      <header class="article-header">
                          <span class="article-date">${date}</span>
                          <h1 class="article-title">${title}</h1>
                          <div class="article-excerpt" style="font-size: 1.25rem; color: #444; margin-top: 1rem; font-style: italic;"><p>${excerpt}</p></div>
                      </header>
                      <div class="article-content">${body}</div>
                      <div style="margin-top: 4rem;"><a href="../blogs.html" style="color: #0044cc; font-weight: bold; text-decoration: none;">&larr; Back to all resources</a></div>
                  </article>
              </main>
              <footer><div class="footer-content"><div><strong>Desmond Delgadillo</strong><p>Assistive Tech Resource Center</p></div><div class="footer-links"><a href="../index.html">Home</a><a href="https://linkedin.com/in/desdelgadillo" target="_blank">LinkedIn</a></div></div></footer>
          </body>
          </html>
          EOF
            fi
          done

      - name: Update JSON
        run: |
          echo "[" > blog.json
          first=true
          for file in posts/*.html; do
            if [[ "$file" == *"blog_template.html"* ]]; then continue; fi
            title=$(sed -n 's/.*<title>\(.*\) | Desmond Delgadillo.*/\1/p' "$file" | head -1)
            date=$(sed -n 's/.*<span class="article-date">\(.*\)<\/span>.*/\1/p' "$file" | head -1)
            excerpt=$(sed -n 's/.*<div class="article-excerpt"[^>]*><p>\(.*\)<\/p><\/div>.*/\1/p' "$file" | head -1)
            
            if [ "$first" = false ]; then echo "," >> blog.json; fi
            echo "  { \"title\": \"$title\", \"date\": \"$date\", \"excerpt\": \"$excerpt\", \"url\": \"$file\" }" >> blog.json
            first=false
          done
          echo "]" >> blog.json

      - name: Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add posts/*.html blog.json
          git commit -m "Auto-build from drafts" || exit 0
          git push
